<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Profile - Perk Manager</title>
    <link rel="stylesheet" href="style.css">
    <script src="auth.js" defer></script>
</head>
<body>

<nav class="global-nav">
    <a href="index.html" class="nav-brand">Perk Manager</a>

    <div class="nav-links">
        <div id="nav-auth-section" class="hidden">
            <span id="nav-username" class="nav-user-text"></span>
            <a href="index.html">Home</a>
            <a href="profile.html">Profile</a>
            <a href="#" id="nav-logout">Logout</a>
        </div>

        <div id="nav-guest-section">
            <a href="login.html">Login</a>
            <a href="register.html">Register</a>
        </div>
    </div>
</nav>

<div class="container" style="display:block; max-width: 600px; margin: 40px auto;">
    <h1>Profile</h1>

    <p id="profile-message">Loading...</p>

    <h2>Your memberships</h2>
    <div id="membership-list"></div>

    <button id="save-btn" class="btn-primary" style="margin-top:20px;">Save Changes</button>
</div>

<script>
    async function loadProfile() {
        const user = await checkAuth();
        if (!user) {
            return;
        }

        const messageEl = document.getElementById("profile-message");
        const listEl = document.getElementById("membership-list");

        try {
            const userMemberships = user.memberships || [];
            const userMembershipIds = userMemberships.map(m => m.id);

            const memRes = await fetch("/api/memberships");
            if (!memRes.ok) {
                messageEl.textContent = "Failed to load memberships.";
                return;
            }
            const memberships = await memRes.json();

            // render the checkboxes
            messageEl.textContent = "";
            listEl.innerHTML = "";

            if (!Array.isArray(memberships) || memberships.length === 0) {
                listEl.textContent = "No memberships available.";
                return;
            }

            memberships.forEach(m => {
                const wrapper = document.createElement("div");
                wrapper.style.padding = "5px 0";

                const cb = document.createElement("input");
                cb.type = "checkbox";
                cb.className = "membership-checkbox";
                cb.dataset.id = m.id;
                cb.style.marginRight = "10px";
                if (userMembershipIds.includes(m.id)) {
                    cb.checked = true;
                }

                const label = document.createElement("label");
                label.textContent = m.name || ("Membership #" + m.id);

                wrapper.appendChild(cb);
                wrapper.appendChild(label);
                listEl.appendChild(wrapper);
            });

        } catch (err) {
            console.error("Error loading profile:", err);
            messageEl.textContent = "Error loading profile.";
        }
    }

    async function saveMemberships() {
        const checkboxes = document.querySelectorAll(".membership-checkbox");
        const selectedIds = [];
        checkboxes.forEach(cb => {
            if (cb.checked) {
                selectedIds.push(Number(cb.dataset.id));
            }
        });

        try {
            const res = await fetch("/api/user/memberships", {
                method: "PUT",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({membershipIds: selectedIds})
            });

            if (res.ok) {
                const updatedUser = await res.json();
                localStorage.setItem('perk_user', JSON.stringify(updatedUser));
                alert("Memberships saved.");
            } else if (res.status === 401 || res.status === 403) {
                alert("Please log in to update your memberships.");
            } else {
                alert("Failed to save memberships.");
            }
        } catch (err) {
            console.error("Error saving memberships:", err);
            alert("Network error while saving memberships.");
        }
    }

    const saveBtn = document.getElementById("save-btn");
    if (saveBtn) {
        saveBtn.addEventListener("click", saveMemberships);
    }

    // Load on page open
    document.addEventListener("DOMContentLoaded", loadProfile);
</script>

</body>
</html>
